!function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),s=function(){function e(){}return e.createAuth=function(t){var n=t.id,r=t.token;return"Basic "+e.base64([n,r].join(":"))},e.base64=function(e){return btoa(e)},e}();t.Utils=s;var o=function(){function e(){}return e.serializeControlMessage=function(e,t,n,r){var s={type:t,details:n};e&&(s.requestId=e);var o={channelCode:0,senderCode:0,history:!1,priority:!1,jsonMessage:s,binaryPayload:r};return this.serializeChannelMessage(o,0,0)},e.serializeChannelMessage=function(e,t,n){var s,o=this.MESSAGE_HEADER_LENGTH;e.jsonMessage&&(o+=4,e.jsonMessage&&(s=(new r.TextEncoder).encode(JSON.stringify(e.jsonMessage)),o+=s.byteLength)),e.binaryPayload&&(o+=e.binaryPayload.byteLength);var i=new Uint8Array(o),a=new DataView(i.buffer),c=Date.now()+n;c<=t&&(c=t+1),a.setUint16(0,this.CHANNEL_ELEMENTS_VERSION_V1);var l=Math.floor(c/Math.pow(2,32));a.setUint16(2,l);var u=c-l*Math.pow(2,32);a.setUint32(4,u),a.setUint32(8,e.channelCode?e.channelCode:0),a.setUint32(12,e.senderCode?e.senderCode:0);var h=0;e.priority&&(h|=1),e.history&&(h|=2),a.setUint8(16,h),i.fill(0,17,this.MESSAGE_HEADER_LENGTH);var f=this.MESSAGE_HEADER_LENGTH;return s&&(a.setUint32(f,s.byteLength),f+=4,i.set(s,f),f+=s.byteLength),e.binaryPayload&&i.set(e.binaryPayload,f),i},e.parseChannelMessage=function(e,t){void 0===t&&(t=!0);var n={valid:!1,rawMessage:e};if(e.length<this.MESSAGE_HEADER_LENGTH)return n.errorMessage="Message is too short",n;var s=new DataView(e.buffer,e.byteOffset);if(s.getUint16(0)!==this.CHANNEL_ELEMENTS_VERSION_V1)return n.errorMessage="Message prefix is invalid.  Incorrect protocol?",n;var o=s.getUint16(2),i=s.getUint32(4),a=o*Math.pow(2,32)+i,c=Date.now()-a;if(t&&Math.abs(c)>15e3)return n.valid=!1,n.errorMessage="Clocks are too far out of sync, or message timestamp is invalid",n;var l=s.getUint8(16),u={serializedMessage:e,timestamp:a,channelCode:s.getUint32(8),senderCode:s.getUint32(12),priority:!!(1&l),history:!!(2&l),fullPayload:new Uint8Array(e.buffer,e.byteOffset+this.MESSAGE_HEADER_LENGTH,e.byteLength-this.MESSAGE_HEADER_LENGTH)};if(n.contents=u,n.valid=!0,0===u.channelCode&&0===u.senderCode){var h=s.getUint32(this.MESSAGE_HEADER_LENGTH);try{var f=new r.TextDecoder("utf-8").decode(e.subarray(this.MESSAGE_HEADER_LENGTH+4,this.MESSAGE_HEADER_LENGTH+4+h));u.controlMessagePayload={jsonMessage:JSON.parse(f)},e.byteLength>this.MESSAGE_HEADER_LENGTH+4+h&&(u.controlMessagePayload.binaryPortion=new Uint8Array(u.fullPayload.buffer,u.fullPayload.byteOffset+4+h,u.fullPayload.byteLength-4-h))}catch(e){n.valid=!1,n.errorMessage="Invalid control message payload"}}return n},e.MESSAGE_HEADER_LENGTH=32,e.CHANNEL_ELEMENTS_VERSION_V1=52913,e}();t.ChannelMessageUtils=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.open=function(){var e=this;return new Promise(function(t,n){if(e.db)return void t();var r=indexedDB.open("channels-db",1);r.onerror=function(e){console.error("Failed to load DB: ",e),n(new Error("Error loading database: "+e))},r.onsuccess=function(n){e.db=r.result,t()},r.onupgradeneeded=function(e){var t=e.target.result;if(!e.oldVersion){t.createObjectStore("registries",{keyPath:"services.registrationUrl"}).createIndex("providerUrl","services.providerUrl",{unique:!0})}}})},e.prototype.getStore=function(e,t){return this.db.transaction(e,t).objectStore(e)},e.prototype.saveRegistry=function(e){var t=this;return new Promise(function(n,r){var s=t.getStore("registries","readwrite");try{var o=s.add(e);o.onerror=function(e){r(new Error("Error saving registry: "+e))},o.onsuccess=function(e){n()}}catch(e){r(e)}})},e.prototype.getRegistry=function(e,t){var n=this;return new Promise(function(r,s){var o,i=n.getStore("registries","readonly");if(e)o=i.get(e);else{if(!t)return void r(null);var a=i.index("providerUrl");o=a.get(t)}o.onerror=function(e){console.error("Failed to load registry from DB: ",e),s(new Error("Failed to load registry: "+e))},o.onsuccess=function(e){r(o.result)}})},e.prototype.getAllRegistries=function(){var e=this;return new Promise(function(t,n){var r=e.getStore("registries","readonly"),s=r.openCursor(),o=[];s.onerror=function(e){console.error("Failed to open registry cursor: ",e),n(new Error("Failed to open registry cursor: "+e))},s.onsuccess=function(e){var n=e.target.result;n?(o.push(n.value),n.continue()):t(o)}})},e}();t.ClientDb=r},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new n(function(t){t(e.value)}).then(i,a)}c((r=r.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(s)throw new TypeError("Generator is already executing.");for(;c;)try{if(s=1,o&&(i=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(i=i.call(o,n[1])).done)return i;switch(o=0,i&&(n=[0,i.value]),n[0]){case 0:case 1:i=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(i=c.trys,!(i=i.length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){c.label=n[1];break}if(6===n[0]&&c.label<i[1]){c.label=i[1],i=n;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(n);break}i[2]&&c.ops.pop(),c.trys.pop();continue}n=t.call(e,c)}catch(e){n=[6,e],o=0}finally{s=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var s,o,i,a,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){}return e.get=function(t,n){return r(this,void 0,void 0,function(){return s(this,function(r){return[2,new Promise(function(r,s){var o=new XMLHttpRequest;if(o.withCredentials=!1,o.open("GET",t),n)for(var i in n)n.hasOwnProperty(i)&&o.setRequestHeader(i,n[i]);o.onload=function(t){var n=o.status;if(0===n||n>=400)o.responseText?e.onError(s,n,o.responseText):e.onError(s,n,"Request failed with code: "+n);else if(o.responseText){var i=JSON.parse(o.responseText);r(i)}else r(null)},o.onerror=function(t){e.onError(s,0,"There was a network error: "+t.message)},o.send()})]})})},e.post=function(t,n,o){return r(this,void 0,void 0,function(){return s(this,function(r){return[2,new Promise(function(r,s){var i=new XMLHttpRequest;if(i.withCredentials=!1,i.open("POST",t),o)for(var a in o)o.hasOwnProperty(a)&&i.setRequestHeader(a,o[a]);i.setRequestHeader("Content-Type","application/json"),i.onload=function(t){var n=i.status;if(0===n||n>=400)i.responseText?e.onError(s,n,i.responseText):e.onError(s,n,"Request failed with code: "+n);else if(i.responseText){var o=JSON.parse(i.responseText);r(o)}else r(null)},i.onerror=function(t){e.onError(s,0,"There was a network error: "+t.message)},n?i.send(JSON.stringify(n)):i.send()})]})})},e.delete=function(t,n){return r(this,void 0,void 0,function(){return s(this,function(r){return[2,new Promise(function(r,s){var o=new XMLHttpRequest;if(o.withCredentials=!1,o.open("DELETE",t),n)for(var i in n)n.hasOwnProperty(i)&&o.setRequestHeader(i,n[i]);o.setRequestHeader("Content-Type","application/json"),o.onload=function(t){var n=o.status;if(0===n||n>=400)o.responseText?e.onError(s,n,o.responseText):e.onError(s,n,"Request failed with code: "+n);else if(o.responseText){var i=JSON.parse(o.responseText);r(i)}else r(null)},o.onerror=function(t){e.onError(s,0,"There was a network error: "+t.message)},o.send()})]})})},e.onError=function(e,t,n){e({status:t,message:n})},e}();t.Rest=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),s=function(){function e(){this.counters={},this.sockets={},this.socketsById={},this.controlCallbacks={}}return e.prototype.connect=function(e,t){var n=this;return new Promise(function(r,s){var o=n.sockets[t];if(o){if(n.socketsById[e]=o,o.connected)return void r();if(o.connecting)return void o.pendingCallbacks.push(function(e){e?s(e):r()})}o?(o.connecting=!0,o.pendingCallbacks=[]):(o={url:t,connected:!1,connecting:!0,pendingCallbacks:[]},n.sockets[t]=o,n.socketsById[e]=o),o.pendingCallbacks.push(function(e){e?s(e):r()}),n.connectSocket(o)})},e.prototype.connectSocket=function(e){var t=this;e.connecting=!0;try{var n=new WebSocket(e.url);n.binaryType="arraybuffer",e.socket=n,n.onopen=function(t){if(n.readyState===WebSocket.OPEN){e.connecting=!1,e.connected=!0;try{for(var r=0,s=e.pendingCallbacks;r<s.length;r++){(0,s[r])()}}catch(e){}}},n.onerror=function(t){try{for(var n=0,r=e.pendingCallbacks;n<r.length;n++){(0,r[n])(t)}}catch(e){}finally{e.connected=!1,e.connecting=!1,e.pendingCallbacks=[]}console.error("Socket error: ",t)},n.onclose=function(t){e.connected=!1,e.connecting=!1,console.error("Socket closed: ",t)},n.onmessage=function(n){t.onMessageReceived(e,n)}}catch(t){try{for(var r=0,s=e.pendingCallbacks;r<s.length;r++){var o=s[r];o(t)}}catch(e){}finally{e.connected=!1,e.connecting=!1,e.pendingCallbacks=[]}}},e.prototype.onMessageReceived=function(e,t){if(t.data){var n=t.data,s=r.ChannelMessageUtils.parseChannelMessage(new Uint8Array(n));return void(s&&s.valid&&s.contents?this.handleMessage(e,s.contents):console.warn("Failed to parse message: ",s?s.errorMessage:"null"))}},e.prototype.handleMessage=function(e,t){if(0===t.channelCode&&t.controlMessagePayload){var n=t.controlMessagePayload.jsonMessage,s=!1;if(n.requestId&&this.controlCallbacks[n.requestId]){var o=this.controlCallbacks[n.requestId];try{o(t)}catch(e){}finally{s=!0,delete this.controlCallbacks[n.requestId]}}if(!s)switch(n.type){case"ping":this.sendControlMessage(e.url,"ping-reply",{},n.requestId);break;case"history-message":if(this.historyMessageHandler){var i=t.controlMessagePayload.binaryPortion,a=r.ChannelMessageUtils.parseChannelMessage(i,!1);if(a&&a.valid){var c=a.contents;try{this.historyMessageHandler(t.controlMessagePayload.jsonMessage.details,c)}catch(e){}}else console.warn("Ignoring history message: Failed to parse.",a?a.errorMessage:"")}break;default:if(this.controlMessageHandler)try{this.controlMessageHandler(t)}catch(e){}}}else if(this.channelMessageHandler)try{this.channelMessageHandler(t)}catch(e){}else console.log("Channel message received",t)},e.prototype.sendControlMessage=function(e,t,n,r,s){var o=this.sockets[e];this.sendControl(r||this.createId("general"),o,t,n,s)},e.prototype.sendControlMessageByChannel=function(e,t,n,r){var s=this.socketsById[e];this.sendControl(this.createId(e),s,t,n,r)},e.prototype.createId=function(e){return this.counters[e]||(this.counters[e]=0),this.counters[e]++,e+"-"+this.counters[e]},e.prototype.sendControl=function(e,t,n,s,o){if(t&&t.connected){o&&(this.controlCallbacks[e]=o);var i=r.ChannelMessageUtils.serializeControlMessage(e,n,s);t.socket.send(i.buffer)}else o&&o(null,new Error("Socket not connected to this destination"))},e.prototype.send=function(e,t){var n=this.socketsById[e];if(!n||!n.connected)throw new Error("Socket not connected to this channel");var s=r.ChannelMessageUtils.serializeChannelMessage(t,0,0);n.socket.send(s.buffer)},e}();t.TransportManager=s},function(e,t,n){"use strict";function r(e,t,n){return t<=e&&e<=n}function s(e){if(void 0===e)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function o(e){for(var t=String(e),n=t.length,r=0,s=[];r<n;){var o=t.charCodeAt(r);if(o<55296||o>57343)s.push(o);else if(56320<=o&&o<=57343)s.push(65533);else if(55296<=o&&o<=56319)if(r===n-1)s.push(65533);else{var i=e.charCodeAt(r+1);if(56320<=i&&i<=57343){var a=1023&o,c=1023&i;s.push(65536+(a<<10)+c),r+=1}else s.push(65533)}r+=1}return s}function i(e){for(var t="",n=0;n<e.length;++n){var r=e[n];r<=65535?t+=String.fromCharCode(r):(r-=65536,t+=String.fromCharCode(55296+(r>>10),56320+(1023&r)))}return t}function a(e){this.tokens=[].slice.call(e)}function c(e,t){if(e)throw TypeError("Decoder error");return t||65533}function l(e,t){if(!(this instanceof l))return new l(e,t);if((e=void 0!==e?String(e).toLowerCase():g)!==g)throw new Error("Encoding not supported. Only utf-8 is supported");t=s(t),this._streaming=!1,this._BOMseen=!1,this._decoder=null,this._fatal=Boolean(t.fatal),this._ignoreBOM=Boolean(t.ignoreBOM),Object.defineProperty(this,"encoding",{value:"utf-8"}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})}function u(e,t){if(!(this instanceof u))return new u(e,t);if((e=void 0!==e?String(e).toLowerCase():g)!==g)throw new Error("Encoding not supported. Only utf-8 is supported");t=s(t),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(t.fatal)},Object.defineProperty(this,"encoding",{value:"utf-8"})}function h(e){var t=e.fatal,n=0,s=0,o=0,i=128,a=191;this.handler=function(e,l){if(l===d&&0!==o)return o=0,c(t);if(l===d)return p;if(0===o){if(r(l,0,127))return l;if(r(l,194,223))o=1,n=l-192;else if(r(l,224,239))224===l&&(i=160),237===l&&(a=159),o=2,n=l-224;else{if(!r(l,240,244))return c(t);240===l&&(i=144),244===l&&(a=143),o=3,n=l-240}return n<<=6*o,null}if(!r(l,i,a))return n=o=s=0,i=128,a=191,e.prepend(l),c(t);if(i=128,a=191,s+=1,n+=l-128<<6*(o-s),s!==o)return null;var u=n;return n=o=s=0,u}}function f(e){e.fatal;this.handler=function(e,t){if(t===d)return p;if(r(t,0,127))return t;var n,s;r(t,128,2047)?(n=1,s=192):r(t,2048,65535)?(n=2,s=224):r(t,65536,1114111)&&(n=3,s=240);for(var o=[(t>>6*n)+s];n>0;){var i=t>>6*(n-1);o.push(128|63&i),n-=1}return o}}var d=-1;a.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():d},prepend:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.unshift(t.pop());else this.tokens.unshift(e)},push:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.push(t.shift());else this.tokens.push(e)}};var p=-1,g="utf-8";l.prototype={decode:function(e,t){var n;n="object"==typeof e&&e instanceof ArrayBuffer?new Uint8Array(e):"object"==typeof e&&"buffer"in e&&e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0),t=s(t),this._streaming||(this._decoder=new h({fatal:this._fatal}),this._BOMseen=!1),this._streaming=Boolean(t.stream);for(var r,o=new a(n),c=[];!o.endOfStream()&&(r=this._decoder.handler(o,o.read()))!==p;)null!==r&&(Array.isArray(r)?c.push.apply(c,r):c.push(r));if(!this._streaming){do{if((r=this._decoder.handler(o,o.read()))===p)break;null!==r&&(Array.isArray(r)?c.push.apply(c,r):c.push(r))}while(!o.endOfStream());this._decoder=null}return c.length&&(-1===["utf-8"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===c[0]?(this._BOMseen=!0,c.shift()):this._BOMseen=!0)),i(c)}},u.prototype={encode:function(e,t){e=e?String(e):"",t=s(t),this._streaming||(this._encoder=new f(this._options)),this._streaming=Boolean(t.stream);for(var n,r=[],i=new a(o(e));!i.endOfStream()&&(n=this._encoder.handler(i,i.read()))!==p;)Array.isArray(n)?r.push.apply(r,n):r.push(n);if(!this._streaming){for(;;){if((n=this._encoder.handler(i,i.read()))===p)break;Array.isArray(n)?r.push.apply(r,n):r.push(n)}this._encoder=null}return new Uint8Array(r)}},t.TextEncoder=u,t.TextDecoder=l},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new n(function(t){t(e.value)}).then(i,a)}c((r=r.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(s)throw new TypeError("Generator is already executing.");for(;c;)try{if(s=1,o&&(i=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(i=i.call(o,n[1])).done)return i;switch(o=0,i&&(n=[0,i.value]),n[0]){case 0:case 1:i=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(i=c.trys,!(i=i.length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){c.label=n[1];break}if(6===n[0]&&c.label<i[1]){c.label=i[1],i=n;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(n);break}i[2]&&c.ops.pop(),c.trys.pop();continue}n=t.call(e,c)}catch(e){n=[6,e],o=0}finally{s=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var s,o,i,a,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),i=n(1),a=n(0),c=n(3),l=function(){function e(){var e=this;this.joinedChannels={},this.joinedChannelsByCode={},this.historyCallbacks={},this.channelMessageCallbacks={},this.channelParticipantListeners={},this.channelDeletedListeners=[],this.db=new i.ClientDb,this.transport=new c.TransportManager,this.transport.historyMessageHandler=function(t,n){var r=e.joinedChannelsByCode[n.channelCode];if(r){var s=e.historyCallbacks[r.channelId];if(s)for(var o=0,i=s;o<i.length;o++){var a=i[o];try{a(t,n)}catch(e){}}}},this.transport.channelMessageHandler=function(t,n){if(!n){var r=e.joinedChannelsByCode[t.channelCode];if(r){var s=e.channelMessageCallbacks[r.channelId];if(s)for(var o=0,i=s;o<i.length;o++){var a=i[o];try{a(t)}catch(e){}}}}},this.transport.controlMessageHandler=function(t,n){n||e.handleControlMessage(t)}}return e.prototype.handleControlMessage=function(e){var t=e.controlMessagePayload.jsonMessage;switch(t.type){case"join-notification":var n=t.details,r=this.channelParticipantListeners[n.channelId];if(r)for(var s=0,o=r;s<o.length;s++){var i=o[s];try{i(n,null)}catch(e){}}break;case"leave-notification":var a=t.details,r=this.channelParticipantListeners[a.channelId];if(r)for(var c=0,l=r;c<l.length;c++){var i=l[c];try{i(null,a)}catch(e){}}break;case"channel-deleted":var u=t.details;if(u)for(var h=0,f=this.channelDeletedListeners;h<f.length;h++){var d=f[h];try{d(u)}catch(e){}}}},e.prototype.addChannelListener=function(e,t,n){switch(e){case"delete":this.channelDeletedListeners.push(n);break;case"participant":this.channelParticipantListeners[t]||(this.channelParticipantListeners[t]=[]),this.channelParticipantListeners[t].push(n);break;case"message":this.channelMessageCallbacks[t]||(this.channelMessageCallbacks[t]=[]),this.channelMessageCallbacks[t].push(n);break;case"history-message":this.historyCallbacks[t]||(this.historyCallbacks[t]=[]),this.historyCallbacks[t].push(n)}},e.prototype.removeChannelListener=function(e,t,n){switch(e){case"delete":for(var r=-1,s=0;s<this.channelDeletedListeners.length;s++)if(n===this.channelDeletedListeners[s]){r=s;break}r>=0&&this.channelDeletedListeners.splice(r,1);break;case"participant":var o=this.channelParticipantListeners[t];if(o){for(var r=-1,s=0;s<o.length;s++)if(n===o[s]){r=s;break}r>=0&&(o.splice(r,1),this.channelParticipantListeners[t]=o)}break;case"message":var o=this.channelMessageCallbacks[t];if(o){for(var r=-1,s=0;s<o.length;s++)if(n===o[s]){r=s;break}r>=0&&(o.splice(r,1),this.channelMessageCallbacks[t]=o)}break;case"history-message":var o=this.historyCallbacks[t];if(o){for(var r=-1,s=0;s<o.length;s++)if(n===o[s]){r=s;break}r>=0&&(o.splice(r,1),this.historyCallbacks[t]=o)}}},e.prototype.ensureDb=function(){return r(this,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return[4,this.db.open()];case 1:return e.sent(),[2]}})})},e.prototype.register=function(e,t){return r(this,void 0,void 0,function(){var n,r,i;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(null,e)];case 2:return n=s.sent(),n?[2,n]:[4,o.Rest.get(e)];case 3:return r=s.sent(),r&&r.services.registrationUrl?[4,this.getRegistry(r.services.registrationUrl,t)]:[3,5];case 4:return i=s.sent(),[2,i];case 5:throw new Error("Failed to fetch channel server info.")}})})},e.prototype.getRegistry=function(e,t){return r(this,void 0,void 0,function(){var n,r;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:return n=s.sent(),n?[2,n]:[4,o.Rest.post(e,{identity:t||{}})];case 3:return r=s.sent(),r?[4,this.db.saveRegistry(r)]:[3,5];case 4:return s.sent(),[2,r];case 5:throw new Error("Failed to register with server at "+e)}})})},e.prototype.createChannel=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n,r;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:if(!(n=s.sent()))throw new Error("Failed to create channel: Provider is not registered");return r={Authorization:a.Utils.createAuth(n)},[4,o.Rest.post(n.services.createChannelUrl,t,r)];case 3:return[2,s.sent()]}})})},e.prototype.shareChannel=function(e,t){return r(this,void 0,void 0,function(){var n,r;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:if(!(n=s.sent()))throw new Error("Failed to create channel: Provider is not registered");return r={Authorization:a.Utils.createAuth(n)},[4,o.Rest.post(n.services.shareChannelUrl,t,r)];case 3:return[2,s.sent()]}})})},e.prototype.getInviteInfo=function(e){return r(this,void 0,void 0,function(){var t;return s(this,function(n){switch(n.label){case 0:return t={"Content-Type":"application/json"},[4,o.Rest.get(e,t)];case 1:return[2,n.sent()]}})})},e.prototype.acceptInvitation=function(e,t,n){return r(this,void 0,void 0,function(){var r,i,c,l;return s(this,function(s){switch(s.label){case 0:return[4,this.getInviteInfo(e)];case 1:if(!(r=s.sent()))throw new Error("Invalid share code");return[4,this.register(r.providerUrl,t)];case 2:return i=s.sent(),c={invitationId:r.invitationId,details:n},l={Authorization:a.Utils.createAuth(i)},[4,o.Rest.post(r.acceptChannelUrl,c,l)];case 3:return[2,s.sent()]}})})},e.prototype.getChannelsWithProvider=function(e){return r(this,void 0,void 0,function(){var t,n,r,o,i,a;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),t=[],[4,this.db.getRegistry(e)];case 2:return n=s.sent(),n?[3,4]:[4,this.db.getRegistry(null,e)];case 3:n=s.sent(),s.label=4;case 4:return n?[4,this.getChannelsFromRegistry(n)]:[3,6];case 5:if((r=s.sent())&&r.channels)for(o=0,i=r.channels;o<i.length;o++)a=i[o],t.push(a);s.label=6;case 6:return[2,t]}})})},e.prototype.listAllChannels=function(){return r(this,void 0,void 0,function(){var e,t,n,r,o,i,a,c,l;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getAllRegistries()];case 2:e=s.sent(),t=[],n=0,r=e,s.label=3;case 3:return n<r.length?(o=r[n],[4,this.getChannelsFromRegistry(o)]):[3,6];case 4:if((i=s.sent())&&i.channels)for(a=0,c=i.channels;a<c.length;a++)l=c[a],t.push(l);s.label=5;case 5:return n++,[3,3];case 6:return t.sort(function(e,t){return t.created-e.created}),[2,t]}})})},e.prototype.getChannelsFromRegistry=function(e){return r(this,void 0,void 0,function(){var t;return s(this,function(n){switch(n.label){case 0:return t={Authorization:a.Utils.createAuth(e)},[4,o.Rest.get(e.services.channelListUrl,t)];case 1:return[2,n.sent()]}})})},e.prototype.getChannel=function(e,t){return r(this,void 0,void 0,function(){var n,r;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:if(!(n=s.sent()))throw new Error("Failed to fetch channel: Provider is not registered");return r={Authorization:a.Utils.createAuth(n)},[4,o.Rest.get(t,r)];case 3:return[2,s.sent()]}})})},e.prototype.deleteChannel=function(e,t){return r(this,void 0,void 0,function(){var n,r;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:if(!(n=s.sent()))throw new Error("Failed to delete channel: Provider is not registered");return r={Authorization:a.Utils.createAuth(n)},[4,o.Rest.delete(t,r)];case 3:return[2,s.sent()]}})})},e.prototype.connectTransport=function(e,t,n){return r(this,void 0,void 0,function(){var r,o,i;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureDb()];case 1:return s.sent(),[4,this.db.getRegistry(e)];case 2:if(!(r=s.sent()))throw new Error("Failed to connect: Provider is not registered");return o=new URL(n),i=o.search||"",i?i.length>1&&(i+="&"):i="?",i+="id="+encodeURIComponent(r.id),i+="&token="+encodeURIComponent(r.token),o.search=i,[4,this.transport.connect(t,o.toString())];case 3:return s.sent(),[2]}})})},e.prototype.joinChannel=function(e){return r(this,void 0,void 0,function(){var t=this;return s(this,function(n){return[2,new Promise(function(n,r){t.transport.sendControlMessageByChannel(e.channelId,"join",e,function(s,o){if(o)r(o);else{var i=s.controlMessagePayload.jsonMessage,a=i.details;t.joinedChannels[e.channelId]=a,t.joinedChannelsByCode[a.channelCode]=a,n(a)}})})]})})},e.prototype.leaveChannel=function(e){return r(this,void 0,void 0,function(){var t=this;return s(this,function(n){return[2,new Promise(function(n,r){t.transport.sendControlMessageByChannel(e.channelId,"leave",e,function(e,t){t?r(t):n()})})]})})},e.prototype.getHistory=function(e){return r(this,void 0,void 0,function(){var t=this;return s(this,function(n){return[2,new Promise(function(n,r){var s=e.channelId;if(!t.joinedChannels[s])return void r(new Error("Trying to fetch history of an unjoined channel"));t.transport.sendControlMessageByChannel(s,"history",e,function(e,t){if(t)r(t);else{var s=e.controlMessagePayload.jsonMessage,o=s.details;n(o)}})})]})})},e.prototype.encode=function(e){var t="string"==typeof e?e:JSON.stringify(e);return(new TextEncoder).encode(t)},e.prototype.decode=function(e,t){return new TextDecoder("utf-8").decode(e)},e.prototype.sendMessage=function(e,t){return r(this,void 0,void 0,function(){var n=this;return s(this,function(r){return[2,new Promise(function(r,s){try{n.transport.send(e,t),r(t)}catch(e){s(e)}})]})})},e}();window.ChannelsClient=l}]);